<?php

namespace App\Http\Controllers\Admin;

use App\Helpers\ImageTrait;
use App\Http\Controllers\Controller;
use App\Http\Requests\Admin\StoreItemRequest;
use App\Http\Requests\Admin\UpdateItemRequest;
use App\Models\Category;
use App\Models\Item;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Yajra\DataTables\Facades\DataTables;

class ItemController extends Controller
{
    use ImageTrait;

    private $title = null;

    public function __construct()
    {
        $this->middleware('permission:item_list|item_create|item_edit|item_delete', ['only' => ['index', 'show', 'getData']]);
        $this->middleware('permission:item_create', ['only' => ['create', 'store']]);
        $this->middleware('permission:item_edit', ['only' => ['edit', 'update',]]);
        $this->middleware('permission:item_delete', ['only' => ['destroy', 'restore', 'forceDelete']]);
        $this->title = 'Item Management';
    }
    public function index(Request $request)
    {
        $title = $this->title;
        $breadcrumbs = ['Item' => route('admin.items.index')];

        return view('admin.items.index', compact('title', 'breadcrumbs'));
    }


    public function create()
    {
        $title = $this->title;
        $categories = Category::where('status', 1)->get();
        $breadcrumbs = ['Item' => route('admin.items.index'), 'Create' => '#'];

        return view('admin.items.create', compact('title', 'categories', 'breadcrumbs'));
    }


    public function store(StoreItemRequest $request)
    {
        if ($image = $request->file('image')) {
            $path = 'items/';
            $imagePath = $this->uploads($image, $path);
        }

        Item::create([
            'name' => $request->name,
            'price' => $request->price,
            'status' => isset($request->status) ? 1 : 0,
            'for_staff' => isset($request->for_staff) ? 1 : 0,
            'category_id' => $request->category_id,
            'image' => isset($imagePath) ? $imagePath : ''

        ]);
        if (isset($request->new)) {
            return redirect()->route('admin.items.create')->with("success", "Item saved successfully");
        } else {
            return redirect()->route('admin.items.index')->with("success", "Item saved successfully");
        }
    }


    public function show($id)
    {
        $breadcrumbs = ['Item' => route('admin.items.index'), 'Show' => '#'];

        $item = Item::findOrFail($id);
        $title = $this->title;

        return view('admin.items.show', compact('item', 'title', 'breadcrumbs'));
    }


    public function edit($id)
    {
        $breadcrumbs = ['Item' => route('admin.items.index'), 'Edit' => '#'];

        $item = Item::findOrFail($id);
        $title = $this->title;
        $categories = Category::where('status', 1)->get();

        return view('admin.items.edit', compact('item', 'categories', 'title', 'breadcrumbs'));
    }


    public function update(UpdateItemRequest $request, Item $item)
    {
        $item->name = $request->name;
        $item->price = $request->price;
        $item->order = $request->order;
        $item->category_id = $request->category_id;
        $item->for_staff = ($request->for_staff) ? 1 : 0;


        if ($image = $request->file('image')) {
            $path = 'items/';
            $this->deleteImage($item->image);
            $imagePath = $this->uploads($image, $path);
            $item->image = $imagePath;
        }
        $item->save();
        return redirect()->route('admin.items.index')->with("success", "Item updated successfully");
    }


    public function destroy(Item $item)
    {
        $item->delete();
        return redirect()->route('admin.items.index')->with("success", "Item deleted successfully");
    }

    public function forceDelete($id)
    {
        $item = Item::onlyTrashed()->findOrFail($id);
        $this->deleteImage($item->image);
        $item->forceDelete();
        return redirect()->route('admin.items.index')->with("success", "Item deleted permanently");
    }

    public function restore($id)
    {
        $item = Item::onlyTrashed()->findOrFail($id);
        $item->restore();
        return redirect()->route('admin.items.index')->with("success", "Item restored successfully");
    }

    public function getData(Request $request)
    {
        if ($request->ajax()) {
            if ($request->mode == 0) {
                $data = Item::select('*')->with('category:id,title')->withCount('order_items');
            } else {
                $data = Item::select('*')->with('category:id,title')->onlyTrashed();
            }
            $canEdit = auth()->user()->can('item_edit');
            $canDelete = auth()->user()->can('item_delete');

            return DataTables::of($data)
                ->setRowClass('row1')
                ->setRowAttr([
                    'data-id' => function ($item) {
                        return $item->id;
                    },
                ])
                // ->editColumn('image', function ($item) {
                //     return $item->image();
                // })
                ->editColumn('status', function ($item) {

                    return ($item->status) ?
                        '<div class="custom-control custom-switch  ">
                    <input type="checkbox" class="custom-control-input changeStatus" checked data-id="' . $item->id . '" id="' . $item->id . '" >
                    <label class="custom-control-label"  for="' . $item->id . '">Active</label>' :

                        '<div class="form-group ">
                    <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input  changeStatus"  data-id="' . $item->id . '" id="' . $item->id . '" >
                    <label class="custom-control-label" for="' . $item->id . '">Inactive</label>
                   ';
                })
                ->editColumn('created_at', function ($item) {
                    return [
                        'display' => $item->created_at->diffForHumans(),
                        'timestamp' => $item->created_at
                    ];
                })
                ->addColumn(
                    'action',
                    function ($row, Request $request) use ($canDelete, $canEdit) {
                        if ($canEdit || $canDelete) {
                            if ($request->mode == 0) {
                                $editBtn =  $canEdit ? '<a class="btn btn-xs btn-warning" href="' . route('admin.items.edit', $row->id) . '" data-toggle="tooltip" title="Edit"><i class="fa fa-pencil-alt"></i></a>' : '';
                                if (!($row->order_items_count)) {
                                    $deleteBtn =  $canDelete ? '<button type="submit" class="btn btn-xs btn-danger btn-delete" data-toggle="tooltip" title="Delete"><i class="fa fa-trash-alt"></i></button>' : '';
                                } else {
                                    $deleteBtn = null;
                                }
                                $formStart = '<form action="' . route('admin.items.destroy', $row->id) . '" method="POST">
                                <input type="hidden" name="_method" value="delete">' . csrf_field();
                                $formEnd = '</form>';
                                $btn = $formStart . $editBtn . ' ' . $deleteBtn . $formEnd;


                                return $btn;
                            } else {
                                $deleteBtn =  $canDelete ? '<button type="submit" class="btn btn-xs btn-danger btn-delete"><i class="fa fa-trash-alt"></i></button>' : '';
                                $formStart = '<form action="' . route('admin.items.forceDelete', $row->id) . '" method="POST">
                                ' . csrf_field() . '
                                <input type="hidden" name="_method" value="delete" />';
                                $restoreBtn = $canDelete ? '<a class="btn btn-xs btn-success" href="' . route('admin.items.restore', $row->id) . '">Restore</a>' : '';
                                $formEnd = '</form>';
                                $btn = $formStart . $restoreBtn . '  ' . $deleteBtn . $formEnd;

                                return $btn;
                            }
                        } else {
                            return 'No Action';
                        }
                    }
                )
                ->rawColumns(['action', 'status'])
                ->make(true);
        }
    }

    public function changeStatus(Request $request)
    {
        $itemId = $request->item_id;
        $status =  $request->status;
        Item::whereId($itemId)->update(['status' => $status]);

        return response()->json([
            'success' => true,
            'status' => $status == 1 ? 'Active' : 'Inactive',
            'checked' => $status == 1 ? true : false,
            'message' => 'Status Successfully Changed!',
        ]);
    }



    public function getCategoryItemsData(Request $request)
    {
        if ($request->ajax()) {
            $category_id = $request->category_id;
            $categoryItems = Item::where('category_id', $category_id)->where('status', 1)->orderBy('category_id', 'desc')->get();
            if ($categoryItems->count()) {
                return response()->json([
                    'items' => $categoryItems,
                    'status' => 'success',
                    'message' => 'success'
                ], 200);
            } else {
                return response()->json([
                    'message' => 'No items for this category available',
                    'status' => 'fail',
                ], 200);
            }
        }
    }
}
